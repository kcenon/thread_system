# Thread System 성능 벤치마크

**버전**: 0.2.0
**최종 업데이트**: 2025-11-15
**언어**: [English](BENCHMARKS.md) | [한국어]

---

## 요약

이 문서는 thread_system의 포괄적인 성능 벤치마크를 제공하며, 실제 측정값, 업계 비교, 최적화 인사이트를 포함합니다.

**플랫폼**: Apple M1 (8코어) @ 3.2GHz, 16GB RAM, macOS Sonoma

**주요 하이라이트**:
- **최대 처리량**: 13.0M jobs/초 (이론적 최대치)
- **프로덕션 처리량**: 1.16M jobs/초 (표준 풀, 10 워커)
- **타입 풀**: 1.24M jobs/초 (우선순위 스케줄링으로 6.9% 빠름)
- **Lock-free 큐**: 뮤텍스보다 4배 빠름 (71 μs vs 291 μs)
- **적응형 큐**: 유리한 경우 최대 7.7배 성능 향상

---

## 목차

1. [핵심 성능 메트릭](#핵심-성능-메트릭)
2. [스레드 풀 벤치마크](#스레드-풀-벤치마크)
3. [큐 성능 비교](#큐-성능-비교)
4. [타입 스레드 풀 성능](#타입-스레드-풀-성능)
5. [워커 스케일링 분석](#워커-스케일링-분석)
6. [라이브러리 비교](#라이브러리-비교)
7. [실제 워크로드](#실제-워크로드)
8. [메모리 사용량](#메모리-사용량)
9. [지연시간 분석](#지연시간-분석)
10. [최적화 인사이트](#최적화-인사이트)

---

## 핵심 성능 메트릭

### 참조 성능 메트릭

Apple M1 (8코어) @ 3.2GHz, 16GB, macOS Sonoma에서 벤치마크됨.

| 메트릭 | 값 | 구성 | 비고 |
|--------|-------|---------------|-------|
| **최대 처리량** | 13.0M jobs/s | 1 워커, 빈 작업 | 이론적 최대치 |
| **프로덕션 처리량** | 1.16M jobs/s | 10 워커, 실제 워크로드 | 프로덕션에서 검증됨 |
| **타입 풀 처리량** | 1.24M jobs/s | 6 워커, 3 타입 | 6.9% 빠름 |
| **작업 스케줄링 지연** | 77 ns | 표준 풀 | 안정적인 기준선 |
| **적응형 큐 지연** | 96-580 ns | 가변 | 자동 최적화 |
| **Lock-free 큐 속도** | 71 μs/op | MPMC 큐 | 뮤텍스보다 4배 빠름 |
| **메모리 기준선** | <1 MB | 표준 풀 | 최소 오버헤드 |
| **스케일링 효율** | 96% | 8 워커 | 우수한 스케일링 |

---

## 스레드 풀 벤치마크

### 표준 스레드 풀 성능

**실제 성능** (실제 워크로드로 측정):

| 구성 | 처리량 | 1M 작업 시간 | 워커 | 효율 | 비고 |
|--------------|------------|--------------|---------|------------|-------|
| **기본 풀** | 1.16M/s | 862 ms | 10 | 100% | 실제 기준선 |
| **적응형 풀** | 동적 | 최적화됨 | 가변 | 자동 | 자동 최적화 |
| **타입 풀** | 1.24M/s | 806 ms | 6 | 107% | 더 적은 워커로 6.9% 빠름 |
| **최대 (빈 작업)** | 13.0M/s | - | 1 | - | 이론적 최대치 |

---

### 적응형 큐 성능

**경합에 따른 자동 최적화**:

| 경합 수준 | 선택된 전략 | 지연시간 | 뮤텍스 전용 대비 | 이점 |
|-----------------|-------------------|---------|---------------|---------|
| **낮음** (1-2 스레드) | 뮤텍스 | 96 ns | 기준선 | 저부하에 최적 |
| **중간** (4 스레드) | 적응형 | 142 ns | +8.2% 빠름 | 균형 잡힌 성능 |
| **높음** (8+ 스레드) | Lock-free | 320 ns | +37% 빠름 | 경합 하에서 확장 |
| **가변 부하** | 자동 전환 | 동적 | 최적화됨 | 자동 |

---

## 큐 성능 비교

### 큐 구현 비교

**단일 작업 성능**:

| 큐 타입 | Enqueue | Dequeue | 총합 | 스레드 | 비고 |
|---------|---------|---------|-------|---------|-------|
| **뮤텍스 큐** | 145 μs | 146 μs | 291 μs | 1 | 기준선 |
| **Lock-free 큐** | 35 μs | 36 μs | **71 μs** | 1 | **4.1배 빠름** |
| **적응형 큐 (저)** | 145 μs | 146 μs | 291 μs | 1-2 | 뮤텍스 사용 |
| **적응형 큐 (고)** | 35 μs | 36 μs | **71 μs** | 8+ | Lock-free로 전환 |

---

### 멀티스레드 큐 성능

**고경합 시나리오** (8 프로듀서, 8 컨슈머):

| 큐 타입 | 처리량 | 지연시간 (P50) | 지연시간 (P99) | CPU 사용량 |
|---------|-----------|---------------|---------------|-----------|
| **뮤텍스 큐** | 580K ops/s | 2.1 μs | 12.4 μs | 95% |
| **Lock-free 큐** | **795K ops/s** | **1.3 μs** | **8.7 μs** | 92% |
| **적응형 큐** | **795K ops/s** | **1.3 μs** | **8.7 μs** | 92% |

**이점**: 적응형 큐는 자동으로 lock-free 모드를 선택하여 +37% 처리량 달성.

---

## 타입 스레드 풀 성능

### 우선순위 기반 스케줄링 성능

| 복잡도 | 처리량 | 기본 풀 대비 | 타입 정확도 | 사용 사례 |
|------------|-----------|--------------|---------------|----------|
| **단일 타입** | 525K/s | -3% | 100% | 특화된 워크로드 |
| **3 타입** | 495K/s | -9% | 99.6% | 표준 우선순위화 |
| **실제 워크로드** | **1.24M/s** | **+6.9%** | 100% | **실제 측정** |

### 타입 기반 라우팅 정확도

| 작업 타입 | 제출된 작업 | 올바른 라우팅 | 정확도 | 평균 지연시간 |
|----------|---------------|---------------|----------|-------------|
| RealTime | 100,000 | 100,000 | 100% | 85 ns |
| Batch | 100,000 | 99,612 | 99.6% | 92 ns |
| Background | 100,000 | 99,588 | 99.6% | 98 ns |
| **총합** | **300,000** | **299,200** | **99.7%** | **평균 92 ns** |

---

## 워커 스케일링 분석

### 워커 스레드 스케일링

| 워커 | 속도 향상 | 효율 | 성능 등급 | 권장 사용 |
|---------|---------|------------|-------------------|-----------------|
| 1 | 1.0x | **100%** | 우수 | 단일 스레드 워크로드 |
| 2 | 2.0x | **99%** | 우수 | 듀얼 코어 시스템 |
| 4 | 3.9x | **97.5%** | 우수 | 쿼드 코어 최적 |
| 8 | 7.7x | **96%** | 매우 좋음 | 표준 멀티 코어 |
| 16 | 15.0x | **94%** | 매우 좋음 | 고성능 워크스테이션 |
| 32 | 28.3x | **88%** | 좋음 | 서버 환경 |

**핵심 인사이트**:
- 8 워커까지 선형에 가까운 스케일링
- 8 워커에서 96% 효율 (Apple M1 최적)
- 하드웨어 스레드 수 이상에서 감소하는 수익
- 32 워커에서도 88% 효율 유지

---

## 라이브러리 비교

### 스레드 풀 라이브러리 비교

| 라이브러리 | 처리량 | 성능 | 평가 | 주요 기능 |
|---------|------------|-------------|---------|--------------|
| **Thread System (타입)** | **1.24M/s** | **107%** | **우수** | 우선순위 스케줄링, 적응형 큐, C++20 |
| **Intel TBB** | ~1.24M/s | **107%** | **우수** | 업계 표준, work stealing |
| **Thread System (표준)** | **1.16M/s** | **100%** | **기준선** | 적응형 큐, 검증된 성능 |
| Boost.Thread Pool | ~1.09M/s | **94%** | 좋음 | 헤더 전용, 이식성 |
| OpenMP | ~1.06M/s | **92%** | 좋음 | 컴파일러 지시문, 사용 용이 |
| std::async | ~267K/s | **23%** | 제한적 | 표준 라이브러리, 기본 기능 |

---

## 실제 워크로드

### 웹 서버 요청 처리

| 요청 타입 | 평균 시간 | 처리량 | 워커 | 풀 타입 |
|-------------|----------|-----------|---------|-----------|
| 정적 파일 | 50 μs | 160K req/s | 8 | 표준 |
| API 호출 | 500 μs | 16K req/s | 8 | 표준 |
| 데이터베이스 쿼리 | 5 ms | 1.6K req/s | 16 | 타입 (우선순위) |
| 무거운 연산 | 50 ms | 160 req/s | 32 | 타입 (백그라운드) |

### 게임 엔진 태스크 스케줄링

| 태스크 타입 | 평균 시간 | 우선순위 | 프레임당 작업 | 풀 구성 |
|-----------|----------|----------|------------|-------------|
| 렌더링 | 8 ms | RealTime | 1 | 타입 풀 (6 워커) |
| 물리 | 4 ms | RealTime | 1 | 타입 풀 |
| AI | 2 ms | Batch | 5 | 타입 풀 |
| 에셋 로딩 | 1 ms | Background | 10 | 타입 풀 |

**결과**: 타입 우선순위 스케줄링으로 안정적인 60 FPS.

---

## 메모리 사용량

### 메모리 기준선

| 워커 | 생성 시간 | 메모리 사용량 | 효율 | 리소스 등급 |
|---------|---------------|--------------|------------|-----------------|
| 1 | **162 ns** | **1.2 MB** | **100%** | 초경량 |
| 4 | **347 ns** | **1.8 MB** | **98%** | 매우 경량 |
| 8 | **578 ns** | **2.6 MB** | **96%** | 경량 |
| 16 | **1.0 μs** | **4.2 MB** | **94%** | 보통 |
| 32 | **2.0 μs** | **7.4 MB** | **88%** | 무거움 |

**메모리 분류** (8 워커):
- 스레드 스택 공간: ~2.0 MB (스레드당 256 KB)
- 큐 구조: ~0.4 MB
- 관리 오버헤드: ~0.2 MB
- **총합**: ~2.6 MB

---

## 지연시간 분석

### 작업 스케줄링 지연시간

| 시나리오 | P50 | P90 | P99 | P99.9 | 비고 |
|----------|-----|-----|-----|-------|-------|
| 표준 풀 (저부하) | 77 ns | 95 ns | 142 ns | 285 ns | 기준선 |
| 표준 풀 (고부하) | 85 ns | 120 ns | 210 ns | 450 ns | 부하 하에서 |
| 적응형 (저경합) | 96 ns | 115 ns | 165 ns | 310 ns | 뮤텍스 모드 |
| 적응형 (고경합) | 320 ns | 425 ns | 680 ns | 1,200 ns | Lock-free 모드 |
| Lock-free 전용 | 280 ns | 380 ns | 620 ns | 1,100 ns | 직접 lock-free |

---

## 최적화 인사이트

### 올바른 큐 선택

```
저경합 (1-4 스레드)
└─ 사용: 표준 뮤텍스 큐 또는 적응형 (자동 뮤텍스 선택)
   이점: 더 낮은 지연시간, 더 간단한 구현

고경합 (8+ 스레드)
└─ 사용: Lock-free 큐 또는 적응형 (자동 lock-free 선택)
   이점: 더 나은 확장성, 더 높은 처리량

가변 부하
└─ 사용: 적응형 큐 (권장)
   이점: 구성 없이 자동 최적화
```

### 워커 풀 크기 조정

```cpp
// CPU 바운드 태스크
size_t workers = std::thread::hardware_concurrency();

// I/O 바운드 태스크
size_t workers = std::thread::hardware_concurrency() * 2;

// 혼합 워크로드
size_t workers = std::thread::hardware_concurrency() * 1.5;
```

---

## 요약

### 핵심 결론

1. **고성능 처리**
   - 1.16M jobs/s 기준 처리량
   - 서브 마이크로초 P50 지연시간
   - 최소 메모리 사용량 (<3 MB)

2. **적응형 최적화**
   - 자동 큐 전략 선택
   - 유리한 경우 최대 7.7배 성능 향상
   - 구성 불필요

3. **우수한 스케일링**
   - 8 워커에서 96% 효율
   - 하드웨어 스레드까지 선형에 가까운 스케일링
   - 그 이후 점진적 감소

4. **업계 경쟁력**
   - Intel TBB 성능과 대등
   - 멀티스레드 로깅에서 spdlog 능가
   - std::async보다 4-5배 우수

---

**참고**:
- [기능 문서](FEATURES.kr.md)
- [성능 기준선](performance/BASELINE.md)
- [아키텍처 가이드](ARCHITECTURE.md)
- [최적화 가이드](guides/PERFORMANCE.md)

---

**최종 업데이트**: 2025-11-15
**관리자**: kcenon@naver.com
