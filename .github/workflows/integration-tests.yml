name: Integration Tests

on:
  push:
    branches: [ main, feat/phase5-integration-testing ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  integration-tests-ubuntu:
    name: Integration Tests (Ubuntu)
    runs-on: ubuntu-latest
    strategy:
      matrix:
        build-type: [Debug, Release]
        compiler:
          - { name: GCC, cc: gcc-11, cxx: g++-11 }
          - { name: Clang, cc: clang-14, cxx: clang++-14 }

    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        submodules: recursive

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          cmake \
          ninja-build \
          ${{ matrix.compiler.cc }} \
          ${{ matrix.compiler.cxx }} \
          libc++-14-dev \
          libc++abi-14-dev \
          libgtest-dev \
          libgmock-dev \
          libfmt-dev

    - name: Checkout common_system (optional dependency)
      continue-on-error: true
      run: |
        cd ..
        if [ ! -d "common_system" ]; then
          git clone https://github.com/kcenon/common_system.git || echo "common_system not available"
        fi

    - name: Configure CMake
      env:
        CC: ${{ matrix.compiler.cc }}
        CXX: ${{ matrix.compiler.cxx }}
      run: |
        BUILD_WITH_COMMON="OFF"
        if [ -d "../common_system" ]; then
          BUILD_WITH_COMMON="ON"
        fi
        cmake -B build \
          -G Ninja \
          -DCMAKE_BUILD_TYPE=${{ matrix.build-type }} \
          -DBUILD_INTEGRATION_TESTS=ON \
          -DBUILD_WITH_COMMON_SYSTEM=$BUILD_WITH_COMMON \
          -DCMAKE_PREFIX_PATH="/usr"

    - name: Build
      run: cmake --build build --config ${{ matrix.build-type }}

    - name: Run Integration Tests
      working-directory: build
      run: |
        ctest --output-on-failure -L integration -C ${{ matrix.build-type }}

    - name: Upload test results
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: integration-test-results-ubuntu-${{ matrix.compiler.name }}-${{ matrix.build-type }}
        path: build/Testing/Temporary/LastTest.log

  integration-tests-macos:
    name: Integration Tests (macOS)
    runs-on: macos-latest
    strategy:
      matrix:
        build-type: [Debug, Release]

    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        submodules: recursive

    - name: Install system dependencies
      run: |
        brew install cmake ninja googletest fmt

    - name: Checkout common_system (optional dependency)
      continue-on-error: true
      run: |
        cd ..
        if [ ! -d "common_system" ]; then
          git clone https://github.com/kcenon/common_system.git || echo "common_system not available"
        fi

    - name: Configure CMake
      run: |
        BUILD_WITH_COMMON="OFF"
        if [ -d "../common_system" ]; then
          BUILD_WITH_COMMON="ON"
        fi
        cmake -B build \
          -G Ninja \
          -DCMAKE_BUILD_TYPE=${{ matrix.build-type }} \
          -DBUILD_INTEGRATION_TESTS=ON \
          -DBUILD_WITH_COMMON_SYSTEM=$BUILD_WITH_COMMON

    - name: Build
      run: cmake --build build --config ${{ matrix.build-type }}

    - name: Run Integration Tests
      working-directory: build
      run: |
        ctest --output-on-failure -L integration -C ${{ matrix.build-type }}

    - name: Upload test results
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: integration-test-results-macos-${{ matrix.build-type }}
        path: build/Testing/Temporary/LastTest.log

  integration-tests-windows:
    name: Integration Tests (Windows)
    runs-on: windows-latest
    strategy:
      matrix:
        build-type: [Debug, Release]

    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        submodules: recursive

    - name: Checkout common_system (optional dependency)
      continue-on-error: true
      run: |
        cd ..
        if (-not (Test-Path "common_system")) {
          git clone https://github.com/kcenon/common_system.git
          if (-not $?) { Write-Host "common_system not available" }
        }

    - name: Setup vcpkg
      uses: lukka/run-vcpkg@v11
      with:
        vcpkgGitCommitId: '50c0cb48a0cf2f6fc5c7b2c0d2bafbe26d0a7ca2'

    - name: Configure CMake
      env:
        VCPKG_FEATURE_FLAGS: manifests
      run: |
        $buildWithCommon = "OFF"
        if (Test-Path "../common_system") {
          $buildWithCommon = "ON"
        }
        cmake -B build `
          -DCMAKE_BUILD_TYPE=${{ matrix.build-type }} `
          -DBUILD_INTEGRATION_TESTS=ON `
          -DBUILD_WITH_COMMON_SYSTEM=$buildWithCommon `
          -DVCPKG_MANIFEST_FEATURES="testing" `
          -DCMAKE_TOOLCHAIN_FILE="$env:VCPKG_ROOT\scripts\buildsystems\vcpkg.cmake"

    - name: Build
      run: cmake --build build --config ${{ matrix.build-type }}

    - name: Run Integration Tests
      working-directory: build
      run: |
        ctest --output-on-failure -L integration -C ${{ matrix.build-type }}

    - name: Upload test results
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: integration-test-results-windows-${{ matrix.build-type }}
        path: build/Testing/Temporary/LastTest.log

  coverage:
    name: Integration Test Coverage
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        submodules: recursive

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          cmake \
          ninja-build \
          gcc-11 \
          g++-11 \
          lcov \
          libgtest-dev \
          libgmock-dev \
          libfmt-dev

    - name: Checkout common_system (optional dependency)
      continue-on-error: true
      run: |
        cd ..
        if [ ! -d "common_system" ]; then
          git clone https://github.com/kcenon/common_system.git || echo "common_system not available"
        fi

    - name: Configure CMake with Coverage
      env:
        CC: gcc-11
        CXX: g++-11
      run: |
        BUILD_WITH_COMMON="OFF"
        if [ -d "../common_system" ]; then
          BUILD_WITH_COMMON="ON"
        fi
        cmake -B build \
          -G Ninja \
          -DCMAKE_BUILD_TYPE=Debug \
          -DBUILD_INTEGRATION_TESTS=ON \
          -DBUILD_WITH_COMMON_SYSTEM=$BUILD_WITH_COMMON \
          -DENABLE_COVERAGE=ON \
          -DCMAKE_PREFIX_PATH="/usr"

    - name: Build
      run: cmake --build build

    - name: Generate Coverage Report
      run: |
        cd build
        lcov --directory . --zerocounters
        ctest --output-on-failure -L integration
        lcov --directory . --capture --output-file coverage/all.info
        lcov --remove coverage/all.info \
          '/usr/*' \
          '*/vcpkg/*' \
          '*/build/*' \
          '*/unittest/*' \
          '*/benchmarks/*' \
          '*/samples/*' \
          '*/test/*' \
          --output-file coverage/all.cleaned.info
        genhtml --demangle-cpp --num-spaces 2 --sort \
          --title "Thread System Integration Coverage" \
          --function-coverage --branch-coverage \
          --output-directory coverage/html \
          coverage/all.cleaned.info

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        files: build/coverage/all.cleaned.info
        flags: integration-tests
        name: integration-tests-coverage

  performance-baseline:
    name: Performance Baseline Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        submodules: recursive

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          cmake \
          ninja-build \
          gcc-11 \
          g++-11 \
          libgtest-dev \
          libgmock-dev \
          libfmt-dev

    - name: Checkout common_system (optional dependency)
      continue-on-error: true
      run: |
        cd ..
        if [ ! -d "common_system" ]; then
          git clone https://github.com/kcenon/common_system.git || echo "common_system not available"
        fi

    - name: Configure CMake
      env:
        CC: gcc-11
        CXX: g++-11
        CI: true
      run: |
        BUILD_WITH_COMMON="OFF"
        if [ -d "../common_system" ]; then
          BUILD_WITH_COMMON="ON"
        fi
        cmake -B build \
          -G Ninja \
          -DCMAKE_BUILD_TYPE=Release \
          -DBUILD_INTEGRATION_TESTS=ON \
          -DBUILD_WITH_COMMON_SYSTEM=$BUILD_WITH_COMMON \
          -DCMAKE_PREFIX_PATH="/usr"

    - name: Build
      run: cmake --build build

    - name: Run Performance Tests
      working-directory: build
      env:
        CI: true
      run: |
        ./bin/integration_tests --gtest_filter=*Performance* --gtest_output=json:performance-results.json

    - name: Upload performance results
      uses: actions/upload-artifact@v4
      with:
        name: performance-baseline
        path: build/performance-results.json
