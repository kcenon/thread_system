@PACKAGE_INIT@

# thread_system CMake configuration file
# This file helps other projects find and use thread_system components
# Standardized naming following Phase 2 T2.1 requirements

include(CMakeFindDependencyMacro)

# Find required dependencies as specified in T2.1
find_dependency(Threads REQUIRED)

# Handle optional dependencies based on configuration
# Check if std::format is used or if we need fmt library
if(DEFINED USE_STD_FORMAT)
    if(NOT USE_STD_FORMAT)
        find_dependency(fmt CONFIG REQUIRED)
    endif()
else()
    # Default case: try to find fmt if available (don't require it)
    find_dependency(fmt CONFIG QUIET)
endif()

# Additional dependencies for full functionality
find_dependency(Iconv QUIET)

# Include the targets file with standardized naming
include("${CMAKE_CURRENT_LIST_DIR}/thread_system-targets.cmake")

# Determine available target structure
# New unified build exports thread_system::ThreadSystem as a single library
# Legacy build exports individual component libraries
if(TARGET thread_system::ThreadSystem)
    # Unified library mode - create component aliases for compatibility
    set(_THREAD_SYSTEM_UNIFIED_MODE TRUE)
    set(_THREAD_SYSTEM_MAIN_TARGET thread_system::ThreadSystem)

    # Create component aliases pointing to the unified library
    if(NOT TARGET thread_system::utilities)
        add_library(thread_system::utilities ALIAS thread_system::ThreadSystem)
    endif()
    if(NOT TARGET thread_system::thread_base)
        add_library(thread_system::thread_base ALIAS thread_system::ThreadSystem)
    endif()
    if(NOT TARGET thread_system::interfaces)
        add_library(thread_system::interfaces ALIAS thread_system::ThreadSystem)
    endif()
    if(NOT TARGET thread_system::thread_pool)
        add_library(thread_system::thread_pool ALIAS thread_system::ThreadSystem)
    endif()
    if(NOT TARGET thread_system::typed_thread_pool)
        add_library(thread_system::typed_thread_pool ALIAS thread_system::ThreadSystem)
    endif()
    if(NOT TARGET thread_system::lockfree)
        add_library(thread_system::lockfree ALIAS thread_system::ThreadSystem)
    endif()
    if(NOT TARGET thread_system::service_container)
        add_library(thread_system::service_container ALIAS thread_system::ThreadSystem)
    endif()

    # Component-wise target exports for compatibility
    set(thread_system_COMPONENT_TARGETS
        thread_system::utilities
        thread_system::thread_base
        thread_system::thread_pool
        thread_system::service_container
        thread_system::lockfree
    )

    # Set main library variable
    set(thread_system_LIBRARIES thread_system::ThreadSystem)
else()
    # Legacy component mode - individual libraries
    set(_THREAD_SYSTEM_UNIFIED_MODE FALSE)

    # Component-wise target exports as required by T2.1
    set(thread_system_COMPONENT_TARGETS "")

    foreach(_component utilities thread_base thread_pool service_container lockfree)
        if(TARGET thread_system::${_component})
            list(APPEND thread_system_COMPONENT_TARGETS thread_system::${_component})
        endif()
    endforeach()

    # Service container is an alias to thread_base (contains service_registry)
    if(TARGET thread_system::thread_base AND NOT TARGET thread_system::service_container)
        add_library(thread_system::service_container ALIAS thread_system::thread_base)
        list(APPEND thread_system_COMPONENT_TARGETS thread_system::service_container)
    endif()

    # Set up convenience variables for all components
    set(thread_system_LIBRARIES ${thread_system_COMPONENT_TARGETS})

    if(NOT thread_system_LIBRARIES)
        message(FATAL_ERROR "No thread_system targets found. Installation may be corrupted.")
    endif()
endif()

# Legacy compatibility - create ThreadSystem:: aliases for backward compatibility
# Note: In unified mode, we must alias from the main target, not from component aliases
# (CMake doesn't allow creating aliases of aliases)
if(_THREAD_SYSTEM_UNIFIED_MODE)
    # Create ThreadSystem:: aliases from the main target
    foreach(_component utilities thread_base thread_pool lockfree interfaces typed_thread_pool)
        if(NOT TARGET ThreadSystem::${_component})
            add_library(ThreadSystem::${_component} ALIAS thread_system::ThreadSystem)
        endif()
    endforeach()
else()
    # In legacy mode, create aliases from actual component targets
    foreach(_component utilities thread_base thread_pool lockfree)
        if(TARGET thread_system::${_component} AND NOT TARGET ThreadSystem::${_component})
            add_library(ThreadSystem::${_component} ALIAS thread_system::${_component})
        endif()
    endforeach()
endif()

# Component handling for find_package with COMPONENTS
set(thread_system_FOUND TRUE)

# Handle specific components if requested
if(thread_system_FIND_COMPONENTS)
    foreach(component ${thread_system_FIND_COMPONENTS})
        set(_component_found FALSE)

        # Check for the component target (with unified mode fallback)
        if(TARGET thread_system::${component})
            set(_component_found TRUE)
        elseif(_THREAD_SYSTEM_UNIFIED_MODE AND TARGET thread_system::ThreadSystem)
            # In unified mode, all components are available through the main target
            set(_component_found TRUE)
        endif()

        if(_component_found)
            set(thread_system_${component}_FOUND TRUE)
        else()
            set(thread_system_${component}_FOUND FALSE)
            if(thread_system_FIND_REQUIRED_${component})
                set(thread_system_FOUND FALSE)
            endif()
        endif()
    endforeach()
endif()

check_required_components(thread_system)